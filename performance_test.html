<!DOCTYPE html>
<html>
    <head>
        <title>WordcloudJS</title>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        
        <link rel="stylesheet" href="libs/Colorpicker/css/colorpicker.css" />
        <link rel="stylesheet" href="libs/Colorpicker/css/layout.css" />
        <link rel="stylesheet" href="assets/main.css" />
    </head>
    <body>
        <div class="loader">
            <div class="loader__progressbar">
                <div class="loader__progress"></div>
                <div class="loader__text">0</div>
            </div>
        </div>
        <header class="header">
            <a class="header__home" href="index.html">Zur√ºck</a>
            <h1 class="header__title">WordcloudJS</h1>
        </header>
        <div id="scene">
            <div id="svgWrapper"></div>
            <div id="timer"></div>            
            <button id="download">Download</button>            
        </div>
        <div id="page">
            <table id="toolbar">
                <tr>
                    <td>
                        <table id="tools">
                            <tr>
                                <td class="tools_title">Schriftart</td>
                                <td class="tools_edit">
                                    <div class="select">
                                        <select id="input_fontfam"></select>
                                        <div class="select_arrow">
                                        </div>
                                    </div>
                                </td>
                                <td class="tools_value" id="value_fontfam">WordcloudJS</td>
                            </tr>
                            <tr>
                                <td class="tools_title">Schriftfarbe</td>
                                <td class="tools_edit">
                                    <div class="divcolorpicker" id="input_color1"></div>
                                    <div class="divcolorpicker" id="input_color2"></div>
                                    <div class="divcolorpicker" id="input_color3"></div>
                                    <div class="divcolorpicker" id="input_color4"></div>
                                </td>
                                <td class="tools_value" id="value_fontcol"></td>
                            </tr>
                            <tr>
                                <td class="tools_title">Schriftrichtung</td>
                                <td class="tools_edit">
                                    <input type="range" min="0" max="3" value="0" id="input_dir"/>
                                </td>
                                <td class="tools_value" id="value_dir">Horizontal</td>
                            </tr>
                            <tr>
                                <td class="tools_title">Path</td>
                                <td class="tools_edit">
                                    <input type="range" min="0" max="1" value="0" id="input_path"/>
                                </td>
                                <td class="tools_value" id="value_path">Spirale</td>
                            </tr>
                        </table>
                    </td>
                    <td>
                        <div id="textbox">
                            <textarea id="textedit" cols="60" rows="16">Banane Erdbeere Kiwi Apfel Acai Kirsche Pflaume Orange Zitrone</textarea>
                            <button id="btn_start">Generieren</button>
                        </div>
                    </td>
                </tr>
            </table>
        </div>
        <script src="node_modules/jquery/dist/jquery.min.js"></script>
        <script src="node_modules/webfontloader/webfontloader.js"></script>
        <script src="libs/Colorpicker/js/colorpicker.js"></script>
        <script src="src/wordcloud.js"></script>
        <script>
            const addWordToScene = (setting) => {
                setTimeout(() => {
                    setting.prog = (setting.anzworte_current / setting.anzworte) * 100;
                    $('.loader__text').html(parseInt(setting.prog));
                    $('.loader__progress').css({'width': setting.prog / 100 * 250 + 'px'});
                    return (() => {
                        var progress = setting.anzworte_current / setting.anzworte;
                        if (setting.anzworte_current < setting.anzworte) {
                            if(setting.currentFontSize > setting.fontSizeMin) {
                                setting.currentFontSize--;
                            }
                        
                            setting.scene.addWord(setting.wc.createWord({
                                text: 'Erdbeere',
                                boundingVolumeMinSize: setting.boundinmgVolumeMinSize,
                                angle: 0,
                                style: {
                                    fontSize: setting.currentFontSize,
                                    fontFamily: setting.fontFam,
                                    fontColor: '#ffffff'
                                }
                            }), 'center', setting.margin);
            
                            setting.anzworte_current++;
            
                            if (setting.anzworte_current < setting.anzworte) {
                                addWordToScene(setting);
                            } else {
                                finishWordcloud(setting);
                            }
                        }
                    })();
                }, 0);
            }
            
            const finishWordcloud = (setting) => {
                const svgScene = setting.scene.getSvg('svgScene');
                const svgWidth = svgScene.getAttribute('width');
                const svgHeight = svgScene.getAttribute('height');
                const windowWidth = window.innerWidth;
                const marginLeft = (windowWidth - parseInt(svgWidth)) / 2;
                svgScene.setAttribute('viewBox', `0 0 ${svgWidth} ${svgHeight}`);
                $('#svgWrapper').css({
                    'width': svgWidth + 'px',
                    'margin-left': marginLeft
                });
                document.getElementById('svgWrapper').appendChild(svgScene);
                $('.loader__text').html('100');
                $('.loader__progress').css({
                    'width': '250px'
                });
                $('.loader').fadeOut(1000);
                t1 = performance.now();
                time = (t1 - t0) / 1000;
                glob_setting = setting;
                $('#timer').html(`Berechnungszeit: ${time.toFixed(2)}s`);
                $('#download, #timer').fadeIn(1000);
            }
            
            function startWordcloud(wc, pathSpir, pathRect) {
                $('.loader_progress').css({
                    'width': '0px'
                });

                $('.loader').css({'display': 'flex'}).fadeIn(500, () => {
                    t0 = performance.now();
                    setTimeout(() => {
                        $('#svgScene').remove();
                        let setting = {
                            wc: wc,
                            i: 0,
                            minAlpha: 0.4,
                            boundinmgVolumeMinSize: 4,
                            modAngle: 5,
                            margin: 0,
                            fontFam: $('#input_fontfam').val(),
                            color1: wc.rgb2hex($('#input_color1').css('background-color')),
                            color2: wc.rgb2hex($('#input_color2').css('background-color')),
                            color3: wc.rgb2hex($('#input_color3').css('background-color')),
                            color4: wc.rgb2hex($('#input_color4').css('background-color')),
                            fontdir: parseInt($('#input_dir').val()),
                            fontSizeMax: 100,
                            fontSizeMin: 8,
                            currentFontSize:100,
                            path: null,
                            scene: null,
                            alpha: parseInt($('#input_alpha').val()),
                            words: [],
                            t_colormod: 1,
                            wordCount: 0,
                            anzworte: 1000,
                            anzworte_current: 0,
                            variant: 1,
                            maxWordCount: null,
                            prog: 0
                        };
            
                        setting.path = parseInt($('#input_path').val()) === 0 ? pathSpir : pathRect;
                        setting.scene = wc.createScene(setting.path);
            
                        addWordToScene(setting);
                    }, 0);
                });
            
            }
            
            $(document).ready(() => {
                $('#input_margin').mousemove(() => {
                    $('#value_margin').html($('#input_margin').val() + ' Pixel');
                });

                $('#input_path').mousemove(() => {
                    if(parseInt($('#input_path').val(), 10) === 1) {
                        $('#value_path').html('Rechteck');
                    } else {
                        $('#value_path').html('Spirale');
                    }
                });

                $('#input_dir').mousemove(() => {
                    if ($('#input_dir').val() == 0) {
                        $('#value_dir').html('Horizontal');
                    } else if ($('#input_dir').val() == 1) {
                        $('#value_dir').html('Vertikal');
                    } else if ($('#input_dir').val() == 2) {
                        $('#value_dir').html('Schief');
                    } else if ($('#input_dir').val() == 3) {
                        $('#value_dir').html('Horizontal und Vertikal');
                    }
                });
            
                /* Setup color picker */
                const colors = {
                    '#input_color1': '32936F',
                    '#input_color2': 'FFBF00',
                    '#input_color3': 'E83F6F',
                    '#input_color4': '2274A5'
                };

                Object.keys(colors).forEach((key) => {
                    $(key).ColorPicker({
                        onChange: (bhs, hex) => {
                            $(key).css({'background-color': `#${hex}`});
                        }
                    });
                    $(key).ColorPickerSetColor(colors[key]);
                    $(key).css({'background-color': `#${colors[key]}`});
                });
            
                let fontFamilies = [
                    'Tangerine',
                    'Molle',
                    'Damion',
                    'Norican',
                    'Blackout',
                    'Robot Crush',
                    'Sketch Book',
                    'BadaBoom BB'
                ];
            
                wc = new WordcloudJS();
                wc.loadFonts({
                    custom: {
                        families: fontFamilies,
                        urls: [
                            'fonts/fonts.css'
                        ]
                    }
                }, () => {
                    fontFamilies.push('Arial');
                    fontFamilies.push('Times New Roman');

                    $('#download').click(() => {
                        wc.downloadSVG(glob_setting.scene.getSvg('svgScene'));
                    });
            
                    for (let i = 0; i < fontFamilies.length; i++) {
                        $('#input_fontfam').append(`<option value="${fontFamilies[i]}">${fontFamilies[i]}</option>`);
                    }
            
                    $('#input_fontfam').change(() => {
                        $('#value_fontfam').css({'font-family': $('#input_fontfam').val()});
                    });
            
                    $('#input_fontfam').val('Molle');
            
                    $('#value_fontfam').css({'font-family': $('#input_fontfam').val()});
            
                    const pathRect = wc.getRectSpiralPath(10, 5, 5000, 5000, 5000);
                    const pathSpir = wc.getSpiralPath(10, 2, 5000, 5000, 5000);
            
                    $('#btn_start').click(() => {
                        startWordcloud(wc, pathSpir, pathRect);
                    });
                });
            });            
        </script>
    </body>
</html>
